<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandcamp Code Verificator</title>
    <meta name="description" content="Verify your Bandcamp download codes easily with Playwright-powered automation.">

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-base: #0a0d14;
            --bg-surface: #10141f;
            --bg-card: #141824;
            --bg-card2: #1a1f30;
            --border: rgba(255, 255, 255, 0.07);
            --border-glow: rgba(99, 102, 241, 0.4);

            --accent: #6366f1;
            --accent-2: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.25);

            --green: #34d399;
            --green-glow: rgba(52, 211, 153, 0.2);
            --red: #f87171;
            --red-glow: rgba(248, 113, 113, 0.2);
            --amber: #fbbf24;
            --amber-glow: rgba(251, 191, 36, 0.15);
            --cyan: #22d3ee;
            --cyan-glow: rgba(34, 211, 238, 0.2);

            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #475569;

            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 24px;
        }

        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: var(--bg-base);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* ‚îÄ‚îÄ Animated Background ‚îÄ‚îÄ */
        body::before {
            content: "";
            position: fixed;
            inset: 0;
            background:
                radial-gradient(ellipse 80% 60% at 10% 10%, rgba(99, 102, 241, 0.08) 0%, transparent 60%),
                radial-gradient(ellipse 60% 50% at 90% 80%, rgba(34, 211, 238, 0.06) 0%, transparent 60%),
                radial-gradient(ellipse 50% 80% at 50% 50%, rgba(52, 211, 153, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .page-wrapper {
            position: relative;
            z-index: 1;
            max-width: 1280px;
            margin: 0 auto;
            padding: 32px 20px 64px;
        }

        /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
        .site-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 36px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .site-logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .logo-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 0 24px var(--accent-glow);
            flex-shrink: 0;
        }

        .logo-text h1 {
            font-size: 1.35rem;
            font-weight: 700;
            line-height: 1.2;
            background: linear-gradient(90deg, var(--text-primary) 0%, var(--accent-2) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .logo-text small {
            font-size: 0.78rem;
            color: var(--text-muted);
            font-weight: 400;
        }

        .header-badge {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 14px;
            background: rgba(52, 211, 153, 0.1);
            border: 1px solid rgba(52, 211, 153, 0.25);
            border-radius: 999px;
            font-size: 0.78rem;
            color: var(--green);
            font-weight: 500;
        }

        .pulse-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
            background: var(--green);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
                transform: scale(1);
            }

            50% {
                opacity: 0.5;
                transform: scale(0.8);
            }
        }

        /* ‚îÄ‚îÄ Layout ‚îÄ‚îÄ */
        .main-grid {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 24px;
            align-items: start;
        }

        @media (max-width: 950px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            overflow: hidden;
            transition: border-color 0.3s;
        }

        .card:hover {
            border-color: rgba(255, 255, 255, 0.12);
        }

        .card-head {
            padding: 20px 24px 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-head-icon {
            width: 34px;
            height: 34px;
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 15px;
            flex-shrink: 0;
        }

        .card-head-icon.purple {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-2);
        }

        .card-head-icon.green {
            background: rgba(52, 211, 153, 0.12);
            color: var(--green);
        }

        .card-head-icon.cyan {
            background: rgba(34, 211, 238, 0.12);
            color: var(--cyan);
        }

        .card-head h2 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-head small {
            font-size: 0.75rem;
            color: var(--text-muted);
            display: block;
            margin-top: 1px;
        }

        .card-body {
            padding: 24px;
        }

        /* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
        .field-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 7px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        input[type="text"],
        textarea {
            width: 100%;
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-primary);
            font-family: inherit;
            font-size: 0.9rem;
            padding: 10px 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            outline: none;
        }

        input[type="text"]:focus,
        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-glow);
        }

        input[type="text"]::placeholder,
        textarea::placeholder {
            color: var(--text-muted);
        }

        textarea {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
            resize: vertical;
            min-height: 220px;
        }

        .field-hint {
            font-size: 0.72rem;
            color: var(--text-muted);
            margin-top: 5px;
        }

        /* ‚îÄ‚îÄ Buttons ‚îÄ‚îÄ */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 7px;
            font-family: inherit;
            font-size: 0.875rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            border-radius: var(--radius-sm);
            padding: 10px 20px;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent) 0%, #7c3aed 100%);
            color: white;
            box-shadow: 0 4px 14px var(--accent-glow);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .btn-danger {
            background: rgba(248, 113, 113, 0.12);
            color: var(--red);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .btn-danger:hover:not(:disabled) {
            background: rgba(248, 113, 113, 0.2);
            box-shadow: 0 0 12px var(--red-glow);
        }

        .btn-success {
            background: rgba(52, 211, 153, 0.12);
            color: var(--green);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .btn-success:hover:not(:disabled) {
            background: rgba(52, 211, 153, 0.2);
            box-shadow: 0 0 12px var(--green-glow);
        }

        .btn-ghost {
            background: transparent;
            color: var(--accent-2);
            border: 1px solid var(--border-glow);
        }

        .btn-ghost:hover:not(:disabled) {
            background: var(--accent-glow);
        }

        .btn-row {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        /* ‚îÄ‚îÄ Alert / Status Banners ‚îÄ‚îÄ */
        .alert {
            border-radius: var(--radius-md);
            padding: 12px 16px;
            font-size: 0.85rem;
            line-height: 1.5;
            margin-bottom: 16px;
        }

        .alert-success {
            background: rgba(52, 211, 153, 0.08);
            border: 1px solid rgba(52, 211, 153, 0.25);
            color: var(--green);
        }

        .alert-warning {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.25);
            color: var(--amber);
        }

        .alert-info {
            background: rgba(34, 211, 238, 0.08);
            border: 1px solid rgba(34, 211, 238, 0.25);
            color: var(--cyan);
        }

        .alert-danger {
            background: rgba(248, 113, 113, 0.08);
            border: 1px solid rgba(248, 113, 113, 0.25);
            color: var(--red);
        }

        /* ‚îÄ‚îÄ Progress Bar ‚îÄ‚îÄ */
        .progress-wrap {
            margin-top: 20px;
        }

        .progress-track {
            height: 6px;
            border-radius: 999px;
            background: var(--bg-surface);
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            border-radius: 999px;
            background: linear-gradient(90deg, var(--accent), var(--cyan));
            transition: width 0.35s ease;
            width: 0%;
            box-shadow: 0 0 10px var(--accent-glow);
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        #statusText {
            color: var(--text-secondary);
        }

        #progressPct {
            color: var(--accent-2);
            font-weight: 600;
        }

        /* ‚îÄ‚îÄ Stats Row ‚îÄ‚îÄ */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card {
            background: var(--bg-surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 14px 16px;
            text-align: center;
        }

        .stat-card .stat-val {
            font-size: 1.6rem;
            font-weight: 700;
            display: block;
        }

        .stat-card .stat-lbl {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
        }

        .stat-card.green .stat-val {
            color: var(--green);
        }

        .stat-card.red .stat-val {
            color: var(--red);
        }

        .stat-card.cyan .stat-val {
            color: var(--cyan);
        }

        /* ‚îÄ‚îÄ Results Table ‚îÄ‚îÄ */
        .results-wrapper {
            margin-top: 24px;
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }

        .results-scroller {
            max-height: 460px;
            overflow-y: auto;
        }

        .results-scroller::-webkit-scrollbar {
            width: 6px;
        }

        .results-scroller::-webkit-scrollbar-track {
            background: var(--bg-card);
        }

        .results-scroller::-webkit-scrollbar-thumb {
            background: var(--text-muted);
            border-radius: 999px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        thead {
            position: sticky;
            top: 0;
            z-index: 5;
            background: var(--bg-card2);
        }

        th {
            padding: 12px 14px;
            font-size: 0.72rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: var(--text-muted);
            border-bottom: 1px solid var(--border);
            text-align: left;
        }

        td {
            padding: 11px 14px;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border);
            vertical-align: middle;
        }

        tbody tr:last-child td {
            border-bottom: none;
        }

        tbody tr:hover td {
            background: rgba(255, 255, 255, 0.03);
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 9px;
            border-radius: 999px;
            font-size: 0.73rem;
            font-weight: 700;
        }

        .badge-success {
            background: rgba(52, 211, 153, 0.15);
            color: var(--green);
            border: 1px solid rgba(52, 211, 153, 0.3);
        }

        .badge-danger {
            background: rgba(248, 113, 113, 0.15);
            color: var(--red);
            border: 1px solid rgba(248, 113, 113, 0.3);
        }

        .resp-cell {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            max-width: 380px;
            overflow-x: auto;
            padding: 6px 10px;
            background: var(--bg-surface);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-all;
        }

        code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.82rem;
            color: var(--accent-2);
            background: rgba(99, 102, 241, 0.1);
            padding: 1px 5px;
            border-radius: 4px;
        }

        /* ‚îÄ‚îÄ Fade-in animation ‚îÄ‚îÄ */
        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeUp 0.3s ease both;
        }

        /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
        .site-footer {
            margin-top: 48px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
            text-align: center;
            font-size: 0.78rem;
            color: var(--text-muted);
        }

        .site-footer span {
            color: var(--accent-2);
        }
    </style>
</head>

<body>
    <div class="page-wrapper">

        <!-- ‚îÄ‚îÄ Header ‚îÄ‚îÄ -->
        <header class="site-header">
            <div class="site-logo">
                <div class="logo-icon">üéµ</div>
                <div class="logo-text">
                    <h1>Bandcamp Code Verificator</h1>
                    <small>Playwright-powered WAF bypass ¬∑ Batch verification</small>
                </div>
            </div>
            <div class="header-badge">
                <div class="pulse-dot"></div>
                Playwright Active
            </div>
        </header>

        <!-- ‚îÄ‚îÄ Main Content ‚îÄ‚îÄ -->
        <div class="main-grid">

            <!-- ‚îÄ‚îÄ LEFT SIDEBAR: Settings ‚îÄ‚îÄ -->
            <div style="display: flex; flex-direction: column; gap: 20px;">

                <!-- Credential Status / Auto-Extract -->
                <div class="card">
                    <div class="card-head">
                        <div class="card-head-icon cyan">üîë</div>
                        <div>
                            <h2>Credentials</h2>
                            <small>Session cookies for Bandcamp</small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if has_credentials %}
                        <div class="alert alert-success">
                            ‚úÖ <strong>Credentials loaded</strong> from <code>.env</code> file. You're ready to go!
                        </div>
                        {% else %}
                        <div class="alert alert-warning">
                            ‚ö†Ô∏è No <code>.env</code> credentials. Enter them manually or use Auto-Extract below.
                        </div>

                        <button type="button" id="btnAutoExtract" class="btn btn-ghost"
                            style="width: 100%; margin-bottom: 12px;">
                            ü§ñ Auto-Extract from Browser
                        </button>
                        <div id="extractStatus" class="alert" style="display: none;"></div>

                        <form id="verifyForm">
                            <div class="field-group">
                                <label for="crumb">Crumb (Optional)</label>
                                <input type="text" id="crumb" placeholder="Auto-fetched if left empty">
                            </div>
                            <div class="field-group">
                                <label for="clientId">Client ID</label>
                                <input type="text" id="clientId" placeholder="2F468B341CC6977..." required>
                            </div>
                            <div class="field-group">
                                <label for="session">Session Cookie</label>
                                <input type="text" id="session" placeholder="1%09r%3A%5B%22..." required>
                            </div>
                            {% endif %}
                    </div>
                </div>

                <!-- Actions Card -->
                <div class="card">
                    <div class="card-head">
                        <div class="card-head-icon purple">‚öôÔ∏è</div>
                        <div>
                            <h2>Controls</h2>
                            <small>Run verification batch</small>
                        </div>
                    </div>
                    <div class="card-body">
                        {% if has_credentials %}<form id="verifyForm">{% endif %}
                            <div class="btn-row">
                                <button type="submit" id="btnStart" class="btn btn-primary" form="verifyForm">
                                    üöÄ Start Verification
                                </button>
                                <button type="button" id="btnStop" class="btn btn-danger" disabled>
                                    ‚èπ Stop
                                </button>
                                <button type="button" id="btnExport" class="btn btn-success" disabled>
                                    üì• Export CSV
                                </button>
                            </div>
                            {% if has_credentials %}
                        </form>{% else %}</form>{% endif %}

                        <!-- Progress -->
                        <div class="progress-wrap">
                            <div class="progress-track">
                                <div id="progressBar" class="progress-bar"></div>
                            </div>
                            <div class="progress-label">
                                <span id="statusText">Ready to verify codes</span>
                                <span id="progressPct">0%</span>
                            </div>
                        </div>

                        <!-- Stats -->
                        <div class="stats-row">
                            <div class="stat-card green">
                                <span id="statValid" class="stat-val">0</span>
                                <span class="stat-lbl">Valid</span>
                            </div>
                            <div class="stat-card red">
                                <span id="statInvalid" class="stat-val">0</span>
                                <span class="stat-lbl">Invalid</span>
                            </div>
                            <div class="stat-card cyan">
                                <span id="statTotal" class="stat-val">0</span>
                                <span class="stat-lbl">Total</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ‚îÄ‚îÄ RIGHT: Codes + Results ‚îÄ‚îÄ -->
            <div style="display: flex; flex-direction: column; gap: 20px;">

                <!-- Codes Input -->
                <div class="card">
                    <div class="card-head">
                        <div class="card-head-icon purple">üìù</div>
                        <div>
                            <h2>Download Codes</h2>
                            <small>One code per line ¬∑ Max {{ max_codes }} codes</small>
                        </div>
                    </div>
                    <div class="card-body">
                        <textarea id="codes" form="verifyForm" placeholder="XXXX-YYYY-ZZZZ&#10;AAAA-BBBB-CCCC&#10;..."
                            required></textarea>
                        <p class="field-hint">Paste your Bandcamp download codes here. Each line = one code.</p>
                    </div>
                </div>

                <!-- Results -->
                <div class="card" id="resultsContainer" style="display: none;">
                    <div class="card-head">
                        <div class="card-head-icon green">üìä</div>
                        <div>
                            <h2>Verification Results</h2>
                            <small>Live results as each code is checked</small>
                        </div>
                    </div>
                    <div class="results-wrapper">
                        <div class="results-scroller">
                            <table>
                                <thead>
                                    <tr>
                                        <th style="width:50px">#</th>
                                        <th style="width:180px">Code</th>
                                        <th style="width:120px">Status</th>
                                        <th style="width:90px">Delay</th>
                                        <th style="width:100px">Time</th>
                                        <th>Response</th>
                                    </tr>
                                </thead>
                                <tbody id="resultsBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- ‚îÄ‚îÄ Footer ‚îÄ‚îÄ -->
        <footer class="site-footer">
            <p>Delay: <span>{{ min_delay }}‚Äì{{ max_delay }}s</span> per request &nbsp;¬∑&nbsp; Powered by
                <span>Playwright</span> &nbsp;¬∑&nbsp; Made with ‚ù§Ô∏è for Bandcamp users</p>
        </footer>
    </div>

    <script>
        const csrfToken = "{{ csrf_token }}";
        const maxCodes = {{ max_codes }};
        const hasCreds = {% if has_credentials %}true{% else %} false{% endif %};

        const el = {
            form: document.getElementById('verifyForm'),
            codes: document.getElementById('codes'),
            crumb: document.getElementById('crumb'),
            clientId: document.getElementById('clientId'),
            session: document.getElementById('session'),
            btnStart: document.getElementById('btnStart'),
            btnStop: document.getElementById('btnStop'),
            btnExport: document.getElementById('btnExport'),
            bar: document.getElementById('progressBar'),
            pct: document.getElementById('progressPct'),
            status: document.getElementById('statusText'),
            results: document.getElementById('resultsContainer'),
            tbody: document.getElementById('resultsBody'),
            statV: document.getElementById('statValid'),
            statI: document.getElementById('statInvalid'),
            statT: document.getElementById('statTotal'),
        };

        let stopFlag = false;
        let results = [];
        let cntValid = 0, cntInvalid = 0;

        function parseCodes(t) {
            return t.split(/\r?\n/).map(l => l.trim()).filter(l => l.length > 0);
        }

        function setProgress(cur, total) {
            const pct = total > 0 ? Math.round((cur / total) * 100) : 0;
            el.bar.style.width = pct + '%';
            el.pct.textContent = pct + '%';
        }

        function setStatus(txt) { el.status.textContent = txt; }

        function updateStats() {
            el.statV.textContent = cntValid;
            el.statI.textContent = cntInvalid;
            el.statT.textContent = results.length;
        }

        function addRow(index, code, status, delaySec, elapsedMs, body, success) {
            const tr = document.createElement('tr');
            tr.className = 'fade-in';

            const badge = success
                ? '<span class="badge badge-success">‚úì Valid</span>'
                : '<span class="badge badge-danger">‚úó Invalid</span>';

            let resp = typeof body === 'object' ? JSON.stringify(body, null, 2) : String(body || '');

            tr.innerHTML = `
            <td style="color:var(--text-muted);font-size:.8rem">${index + 1}</td>
            <td><code>${esc(code.substring(0, 30))}${code.length > 30 ? '‚Ä¶' : ''}</code></td>
            <td>${badge}<br><span style="font-size:.72rem;color:var(--text-muted)">HTTP ${status}</span></td>
            <td style="color:var(--text-secondary)">${delaySec}s</td>
            <td style="color:var(--text-secondary)">${elapsedMs.toFixed(0)}ms</td>
            <td><div class="resp-cell">${esc(resp)}</div></td>
        `;
            el.tbody.appendChild(tr);
            const scroller = document.querySelector('.results-scroller');
            if (scroller) scroller.scrollTop = scroller.scrollHeight;
        }

        function esc(t) {
            const d = document.createElement('div');
            d.textContent = t;
            return d.innerHTML;
        }

        async function verifyCode(code, index, total) {
            const payload = { csrf_token: csrfToken, code, index, total };
            if (el.crumb) payload.crumb = el.crumb.value.trim();
            if (el.clientId) payload.client_id = el.clientId.value.trim();
            if (el.session) payload.session = el.session.value.trim();

            const r = await fetch('/api/verify', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            return { status: r.status, ...(await r.json()) };
        }

        function buildCSV() {
            const hdr = ['No', 'Code', 'HTTP Status', 'Delay (s)', 'Time (ms)', 'Response', 'Success'];
            const rows = [hdr.join(',')];
            results.forEach((r, i) => {
                const resp = typeof r.body === 'object' ? JSON.stringify(r.body) : String(r.body || '');
                rows.push([i + 1, `"${r.code.replace(/"/g, '""')}"`, r.status, r.delay_sec,
                r.elapsed_ms.toFixed(0), `"${resp.replace(/"/g, '""')}"`,
                r.success ? 'Yes' : 'No'].join(','));
            });
            return rows.join('\n');
        }

        el.form.addEventListener('submit', async (e) => {
            e.preventDefault();
            const codes = parseCodes(el.codes.value);
            if (!codes.length) { alert('No codes entered!'); return; }
            if (codes.length > maxCodes) { alert(`Max ${maxCodes} codes allowed.`); return; }

            stopFlag = false; results = []; cntValid = 0; cntInvalid = 0;
            el.tbody.innerHTML = '';
            el.results.style.display = 'block';
            setProgress(0, codes.length);
            updateStats();

            el.btnStart.disabled = true;
            el.btnStop.disabled = false;
            el.btnExport.disabled = true;
            el.form.querySelectorAll('input, textarea').forEach(el => el.disabled = true);

            setStatus('Starting verification...');

            for (let i = 0; i < codes.length; i++) {
                if (stopFlag) { setStatus('‚ùå Stopped by user'); break; }
                const code = codes[i];
                setStatus(`‚è≥ Verifying ${i + 1}/${codes.length}: ${code.substring(0, 24)}‚Ä¶`);

                try {
                    const r = await verifyCode(code, i, codes.length);
                    const ok = r.ok === true;
                    if (ok) cntValid++; else cntInvalid++;
                    addRow(i, code, r.status || 0, r.delay_sec || 0, r.elapsed_ms || 0, r.body, ok);
                    results.push({ code, status: r.status || 0, delay_sec: r.delay_sec || 0, elapsed_ms: r.elapsed_ms || 0, body: r.body, success: ok });
                } catch (err) {
                    cntInvalid++;
                    addRow(i, code, 0, 0, 0, `Error: ${err.message}`, false);
                    results.push({ code, status: 0, delay_sec: 0, elapsed_ms: 0, body: `Error: ${err.message}`, success: false });
                }
                setProgress(i + 1, codes.length);
                updateStats();
            }

            el.btnStart.disabled = false;
            el.btnStop.disabled = true;
            el.btnExport.disabled = false;
            el.form.querySelectorAll('input, textarea').forEach(el => el.disabled = false);
            setStatus(`‚úÖ Complete! ${cntValid}/${results.length} codes verified successfully`);
        });

        el.btnStop.addEventListener('click', () => {
            stopFlag = true; el.btnStop.disabled = true; setStatus('Stopping‚Ä¶');
        });

        el.btnExport.addEventListener('click', () => {
            if (!results.length) return;
            const blob = new Blob([buildCSV()], { type: 'text/csv;charset=utf-8;' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `bandcamp_results_${Date.now()}.csv`;
            a.click();
        });

        // Auto-Extract
        const btnAE = document.getElementById('btnAutoExtract');
        const aeStatus = document.getElementById('extractStatus');

        if (btnAE) {
            btnAE.addEventListener('click', async () => {
                btnAE.disabled = true;
                btnAE.textContent = '‚è≥ Opening browser window‚Ä¶';
                aeStatus.className = 'alert alert-info';
                aeStatus.style.display = 'block';
                aeStatus.textContent = 'üîç Launching secure Chromium window‚Ä¶ Please log into Bandcamp if prompted. (Max 60 seconds)';

                try {
                    const r = await fetch('/api/auto-extract', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ csrf_token: csrfToken }),
                    });
                    const data = await r.json();

                    if (data.ok && data.credentials) {
                        if (data.credentials.client_id && el.clientId) el.clientId.value = data.credentials.client_id;
                        if (data.credentials.session && el.session) el.session.value = data.credentials.session;
                        if (data.credentials.crumb && el.crumb) el.crumb.value = data.credentials.crumb;

                        aeStatus.className = 'alert alert-success';
                        aeStatus.innerHTML = '‚úÖ <strong>Success!</strong> Credentials extracted and filled. You can now verify codes.';
                        btnAE.textContent = '‚úì Extracted!';
                    } else {
                        aeStatus.className = 'alert alert-danger';
                        aeStatus.innerHTML = `‚úó <strong>Failed:</strong> ${data.error || 'Could not extract credentials'}<br><small>Did not detect Bandcamp login in the 60-second window.</small>`;
                        btnAE.textContent = 'ü§ñ Try Again';
                        btnAE.disabled = false;
                    }
                } catch (err) {
                    aeStatus.className = 'alert alert-danger';
                    aeStatus.innerHTML = `‚úó <strong>Error:</strong> ${err.message}<br><small>Check Python terminal for Playwright error details.</small>`;
                    btnAE.textContent = 'ü§ñ Try Again';
                    btnAE.disabled = false;
                }
            });
        }
    </script>

</body>

</html>