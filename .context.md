# Bandcamp Code Verificator - Project Context

## Overview
**Bandcamp Code Verificator** adalah sistem Python profesional untuk memverifikasi download codes Bandcamp secara batch dengan dual interface (CLI & Web). Sistem ini mendukung auto-extraction credentials dari browser untuk kemudahan maksimal.

**Repository**: https://github.com/angki/bandcamp_codes_verificator  
**Version**: 1.0.0  
**License**: MIT  
**Author**: angki

## Tech Stack

### Core
- **Python 3.7+**: Main language
- **Flask 3.0+**: Web framework
- **requests**: HTTP client library
- **click**: CLI framework
- **rich**: Enhanced CLI output (progress bars, colors, tables)

### Features
- **playwright**: Headless browser automation (Fastly WAF Bypass)
- **python-dotenv**: Environment variable management
- **Flask-Limiter**: API rate limiting
- **browser-cookie3**: (Legacy) Auto-extract cookies from browser
- **beautifulsoup4**: HTML parsing for crumb extraction

## Project Structure

```
bandcamp_codes_verificator/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ __init__.py              # Package initialization
‚îÇ   ‚îú‚îÄ‚îÄ config.py                # Centralized configuration
‚îÇ   ‚îú‚îÄ‚îÄ logger.py                # Structured JSON logging
‚îÇ   ‚îú‚îÄ‚îÄ utils.py                 # Utility functions (sanitization, validation, I/O)
‚îÇ   ‚îú‚îÄ‚îÄ verificator.py           # Core verification logic
‚îÇ   ‚îú‚îÄ‚îÄ auto_extract.py          # üÜï Smart credential auto-extraction
‚îÇ   ‚îî‚îÄ‚îÄ web/
‚îÇ       ‚îú‚îÄ‚îÄ __init__.py
‚îÇ       ‚îú‚îÄ‚îÄ app.py               # Flask application
‚îÇ       ‚îî‚îÄ‚îÄ templates/
‚îÇ           ‚îî‚îÄ‚îÄ index.html       # Web UI with modern gradient design
‚îÇ
‚îú‚îÄ‚îÄ tests/
‚îÇ   ‚îî‚îÄ‚îÄ sample_codes.txt         # Sample test data
‚îÇ
‚îú‚îÄ‚îÄ cli.py                       # CLI entry point
‚îú‚îÄ‚îÄ run_web.py                   # Web server launcher
‚îú‚îÄ‚îÄ requirements.txt             # Python dependencies
‚îú‚îÄ‚îÄ config.example.json          # Example configuration
‚îú‚îÄ‚îÄ .env.example                 # Environment variables template
‚îú‚îÄ‚îÄ .gitignore                   # Git ignore rules
‚îú‚îÄ‚îÄ LICENSE                      # MIT License
‚îú‚îÄ‚îÄ README.md                    # Main documentation
‚îú‚îÄ‚îÄ QUICKSTART_ID.md            # Quick start guide (Indonesian)
‚îú‚îÄ‚îÄ SETUP_ID.md                 # Setup guide (Indonesian)
‚îú‚îÄ‚îÄ AUTO_EXTRACT_ID.md          # üÜï Auto-extraction feature docs
‚îî‚îÄ‚îÄ .context.md                 # This file

```

## Key Components

### 1. Configuration (app/config.py)
**Purpose**: Centralized application settings  
**Features**:
- Environment variable support via dotenv
- Bandcamp API settings (base URL, endpoints, timeouts)
- Rate limiting configuration (1-5 sec delays)
- Logging settings (level, rotation, format)
- Flask web settings (secret key, CSRF, sessions)
- Auto-loaded credentials (BANDCAMP_CRUMB, BANDCAMP_CLIENT_ID, BANDCAMP_SESSION, BANDCAMP_IDENTITY)

**Key Methods**:
- `Config.from_env()`: Load from environment variables
- `Config.validate()`: Validate settings
- `Config.has_credentials()`: Check if credentials are configured

### 2. Logger (app/logger.py)
**Purpose**: Structured JSON logging with rotation  
**Features**:
- JSON format for easy parsing
- Rotating file handler (10MB max, 5 backups)
- Console output for debugging
- Special method `log_verification()` for verification events

**Usage**:
```python
from app.logger import logger
logger.info("Message")
logger.log_verification(code, status, success, ...)
```

### 3. Utilities (app/utils.py)
**Purpose**: Common helper functions  
**Functions**:
- `sanitize_codes()`: Clean and normalize code inputs
- `sanitize_cookie()`: Sanitize cookie values
- `validate_input()`: Validate user inputs
- `read_codes_from_file()`: Read codes from text file
- `export_to_csv()`: Export results to CSV
- `export_to_json()`: Export results to JSON
- `generate_csrf_token()`: Generate CSRF tokens

### 4. Verificator (app/verificator.py)
**Purpose**: Core Bandcamp verification logic  
**Class**: `BandcampVerificator`

**Features**:
- Headless Playwright Chromium integration to perfectly mock human validation and bypass Fastly WAF HTTP 403s.
- Automatic DOM-based polling for correct checkmark and validation response parsing without touching `requests`.
- Rate limiting with random delays (1-5 seconds)
- Single code verification (`verify_code()`)
- Batch processing (`verify_batch()`)
- Progress callbacks for UI updates

**API Endpoint**: `POST /api/codes/1/verify` (Intercepted internally by Playwright)  
**Required Cookies**: `client_id`, `session`, `identity`  

### 5. Auto-Extraction (app/auto_extract.py) üÜï
**Purpose**: Smart credential extraction from browser  
**Class**: `CredentialExtractor`

**How It Works**:
1. **Browser Cookie Extraction**: Uses `browser-cookie3` to read cookies from Chrome/Firefox/Edge.
2. **Crumb Scraping**: Uses a silent Playwright Chromium instance to load bandcamp.com/yum, bypassing the WAF blocks, and extracts crumb from HTML.
3. **Auto-Fill**: Returns credentials for automatic form population.

**Methods**:
- `extract_from_browser(browser_name)`: Extract cookies
- `extract_crumb_from_page()`: Scrape crumb from Bandcamp using Playwright Headless
- `auto_extract()`: One-shot extraction of all credentials
- `CredentialExtractor.get_credentials()`: Static helper method

**Supported Browsers**: Chrome, Firefox, Edge, Chromium (Cookies) & Playwright (Browser Context)

### 6. CLI Interface (cli.py)
**Purpose**: Command-line interface with rich output  
**Framework**: Click + Rich

**Commands**:
```bash
# Verify codes
python cli.py verify --input codes.txt --output results.csv

# Options
--crumb TEXT          # Bandcamp crumb (or use env)
--client-id TEXT      # Client ID (or use env)
--session TEXT        # Session cookie (or use env)
--identity TEXT       # Identity cookie (or use env, required for WAF)
--format [csv|json]   # Output format
--verbose             # Detailed output
--dry-run             # Test without actual verification
```

**Features**:
- Progress bar with ETA
- Colored output (green=success, red=fail)
- Results table with statistics
- Export to CSV/JSON

### 7. Web Interface (app/web/app.py)
**Purpose**: Flask web application  
**Features**:
- CSRF protection (session-based tokens)
- Rate limiting (10 requests/min for verify, 5/min for auto-extract)
- Session management with secure cookies
- Conditional credential form (hidden if .env configured)

**API Endpoints**:

| Endpoint | Method | Rate Limit | Purpose |
|----------|--------|------------|---------|
| `/` | GET | - | Main page |
| `/api/verify` | POST | 10/min | Verify single code |
| `/api/auto-extract` | POST | 5/min | üÜï Auto-extract credentials |
| `/api/health` | GET | - | Health check |

**Security**:
- CSRF tokens on all POST requests
- SESSION_COOKIE_SECURE, HTTPONLY, SAMESITE
- Input sanitization on all inputs
- Rate limiting per IP

### 8. Web UI (app/web/templates/index.html)
**Purpose**: Modern gradient-based web interface  
**Design**: Bootstrap 5 + Custom CSS

**Features**:
- üé® Modern gradient design (purple ‚Üí indigo)
- üìù Text area for code input (max 1000 codes)
- ü§ñ **Auto-Extract Button** - One-click credential extraction
- üîÑ Real-time AJAX progress updates
- üìä Live results table with animations
- üì• CSV export functionality
- üö¶ Status indicators and progress bar

**UX Flow**:
1. User clicks "Auto-Extract" ‚Üí system reads browser cookies ‚Üí form auto-fills
2. User pastes codes ‚Üí clicks "Start Verification"
3. Real-time updates show progress
4. Results appear in table as each code is verified
5. Export to CSV when complete

## Data Flow

### CLI Flow
```
User ‚Üí cli.py ‚Üí read codes.txt ‚Üí BandcampVerificator 
  ‚Üí verify_batch() ‚Üí API calls with delays 
  ‚Üí results ‚Üí export_to_csv() ‚Üí results.csv
```

### Web Flow
```
User ‚Üí Browser ‚Üí /api/auto-extract ‚Üí CredentialExtractor 
  ‚Üí browser cookies ‚Üí auto-fill form
  
User ‚Üí paste codes ‚Üí /api/verify (AJAX per code) 
  ‚Üí BandcampVerificator ‚Üí verify_code() 
  ‚Üí JSON response ‚Üí update UI ‚Üí repeat
  
User ‚Üí Export CSV ‚Üí client-side generation ‚Üí download
```

### Auto-Extraction Flow
```
User clicks "Auto-Extract" 
  ‚Üí POST /api/auto-extract
  ‚Üí CredentialExtractor.extract_from_browser()
    ‚Üí finds client_id, session, identity cookies
  ‚Üí CredentialExtractor.extract_crumb_from_page()
    ‚Üí Playwright Chromium loads bandcamp.com/yum
    ‚Üí BeautifulSoup parses HTML for data-crumb
  ‚Üí Return {crumb, client_id, session, identity}
  ‚Üí JavaScript fills form fields
```

## Configuration

### Environment Variables (.env)
```env
# Credentials (auto-loaded if present)
BANDCAMP_CRUMB=|api/codes/1/verify|1759468523|...
BANDCAMP_CLIENT_ID=2F468B341CC...
BANDCAMP_SESSION=1%09r%3A%5B%22...
BANDCAMP_IDENTITY=7%09ORa7wa4GGV7...

# Optional overrides
SECRET_KEY=your-secret-key-here
FLASK_ENV=development
MIN_DELAY_SEC=1
MAX_DELAY_SEC=5
LOG_LEVEL=INFO
```

### How to Get Credentials

**Method 1: Auto-Extraction (Recommended)** üÜï
1. Login to Bandcamp in browser
2. Visit bandcamp.com/yum
3. Run web app, click "Auto-Extract"
4. Done!

**Method 2: Manual via Browser DevTools**
1. Login to Bandcamp
2. Open DevTools (F12) ‚Üí Network tab
3. Visit bandcamp.com/yum and verify any code
4. Find POST /verify request
5. Copy `client_id`, `session`, and `identity` from Cookies
6. Copy `crumb` from Request Payload

**Method 3: Save to .env File**
1. Copy `.env.example` to `.env`
2. Fill in credentials (from Method 1 or 2)
3. Credentials auto-load on app start

## Development Setup

### Installation
```bash
# Clone repo
git clone https://github.com/angki/bandcamp_codes_verificator.git
cd bandcamp_codes_verificator

# Install dependencies
pip install -r requirements.txt

# Optional: Setup .env for auto-credentials
cp .env.example .env
# Edit .env with your credentials
```

### Running

**Web Interface**:
```bash
python run_web.py
# Open: http://127.0.0.1:5000
```

**CLI**:
```bash
# Quick verify
python cli.py verify --input codes.txt

# With specific credentials
python cli.py verify --input codes.txt \
  --crumb "..." \
  --client-id "..." \
  --session "..." \
  --output results.csv

# Dry run
python cli.py verify --input codes.txt --dry-run
```

### Testing
```bash
# Test auto-extraction
python app/auto_extract.py

# Test with sample codes
python cli.py verify --input tests/sample_codes.txt --verbose
```

## Known Issues & Limitations

### Current Limitations
1. **Crumb Expiration**: Crumb tokens expire after ~1 hour, need re-extraction
2. **Session Management**: Browser session must remain active
3. **Rate Limiting**: Bandcamp may block if too many requests (hence 1-5s delays)
4. **Browser Lock**: Some browsers lock cookie databases while running

### Workarounds
1. **Crumb Expiration**: Use auto-extract button to refresh
2. **Session Issues**: Keep browser logged in during verification
3. **Rate Limiting**: System enforces delays automatically
4. **Browser Lock**: Close browser before auto-extract, or use manual method

### Error Handling
- **Network Errors**: Automatic retry with exponential backoff (3 attempts)
- **Invalid Credentials**: Clear error messages with suggestions
- **Browser Cookie Access**: Falls back to manual input if extraction fails
- **API Errors**: Logged with full context for debugging

## Future Enhancements

### Planned Features
- [ ] Async batch processing for faster verification
- [ ] Database storage for verification history
- [ ] Multi-user support with authentication
- [ ] Scheduled verification jobs
- [ ] Email notifications on completion
- [ ] Support for more browsers (Safari, Opera)
- [ ] Auto-refresh crumb when expired
- [ ] Docker containerization
- [ ] API for external integrations

### Performance Improvements
- [ ] Parallel processing (respecting rate limits)
- [ ] Caching layer for repeated codes
- [ ] WebSocket for real-time updates
- [ ] Result pagination for large batches

## API Reference

### BandcampVerificator Class

```python
from app.verificator import BandcampVerificator

# Initialize
verificator = BandcampVerificator(
    crumb="...",
    client_id="...",
    session="..."
)

# Verify single code
result = verificator.verify_code("code-here")
# Returns: {
#   "ok": True/False,
#   "status": 200,
#   "body": {...},
#   "elapsed_ms": 1234.5,
#   "delay_sec": 3,
#   "error": None
# }

# Verify batch
results = verificator.verify_batch(
    codes=["code1", "code2", ...],
    progress_callback=lambda i, total: print(f"{i}/{total}")
)
```

### CredentialExtractor Class üÜï

```python
from app.auto_extract import CredentialExtractor

# Quick extraction
credentials = CredentialExtractor.get_credentials()
# Returns: {
#   "client_id": "...",
#   "session": "...",
#   "crumb": "..."
# }

# With specific browser
credentials = CredentialExtractor.get_credentials(browser_name="chrome")

# Manual control
extractor = CredentialExtractor()
success, creds = extractor.auto_extract()
if success:
    print(f"Client ID: {creds['client_id']}")
```

## Deployment

### Production Checklist
- [ ] Set strong SECRET_KEY in environment
- [ ] Use production WSGI server (gunicorn/waitress)
- [ ] Enable HTTPS for web interface
- [ ] Set LOG_LEVEL=WARNING
- [ ] Configure log rotation
- [ ] Set up monitoring/alerting
- [ ] Backup verification logs

### Gunicorn Example
```bash
# Install gunicorn
pip install gunicorn

# Run with 4 workers
gunicorn -w 4 -b 0.0.0.0:5000 "app.web.app:create_app()"
```

## Security Considerations

### Current Security Measures
1. **CSRF Protection**: Token validation on all POST requests
2. **Rate Limiting**: Per-IP limits on API endpoints
3. **Input Sanitization**: All inputs validated and cleaned
4. **Secure Sessions**: HTTPOnly, Secure, SameSite cookies
5. **No Credential Storage**: Auto-extracted credentials not saved to disk

### Best Practices
- Never commit `.env` file (in `.gitignore`)
- Rotate credentials regularly
- Use HTTPS in production
- Monitor logs for suspicious activity
- Keep dependencies updated

## Contributing

### Code Style
- PEP 8 compliance
- Type hints where applicable
- Docstrings for all public functions
- Comprehensive error handling

### Pull Request Process
1. Fork the repository
2. Create feature branch
3. Add tests if applicable
4. Update documentation
5. Submit PR with clear description

## License
MIT License - See LICENSE file

## Support
- **Issues**: https://github.com/angki/bandcamp_codes_verificator/issues
- **Discussions**: Use GitHub Discussions for questions

---

**Last Updated**: 2026-02-11  
**Project Status**: Production Ready ‚úÖ  
**New Feature**: Smart Auto-Extraction ü§ñ
